name: AI Issue Helper

on:
  issues:
    types: [opened, edited]

jobs:
  suggest_solution:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          pip install openai pygithub

      - name: Generate AI Proposal
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python << 'EOF'
          import os
          import openai
          from github import Github

          # GitHub and OpenAI Setup
          GITHUB_TOKEN = os.getenv("GITHUB_TOKEN")
          OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
          ISSUE_NUMBER = os.getenv("ISSUE_NUMBER")
          REPO_NAME = os.getenv("GITHUB_REPOSITORY")

          # Connect to GitHub
          g = Github(GITHUB_TOKEN)
          repo = g.get_repo(REPO_NAME)

          # Fetch Issue Details
          issue = repo.get_issue(int(os.getenv("ISSUE_NUMBER")))
          issue_title = issue.title
          issue_body = issue.body

          # OpenAI Prompt
          openai.api_key = OPENAI_API_KEY
          prompt = (
              "Jsi seniorn칤 softwarov칳 in쬰n칳r. "
              "Analyzuj n치sleduj칤c칤 popis probl칠mu a navrhni 콏e코en칤. "
              "V칳stup by m캩l b칳t ve form치tu git diff nebo jasn캩 strukturovan칳 n치vrh. "
              "V코e pi코 캜esky.\n\n"
              f"Issue: {issue_title}\n\nPopis:\n{issue_body}"
          )

          response = openai.ChatCompletion.create(
              model="gpt-4",
              messages=[
                  {"role": "user", "content": prompt}
              ]
          )

          solution = response["choices"][0]["message"]["content"]

          # Post Comment to Issue
          issue.create_comment(
              "游뱄 **AI n치vrh 콏e코en칤**\n\n"
              f"{solution}\n\n"
              "_Toto je automaticky generovan칳 n치vrh, pros칤m zkontrolujte._"
          )
          EOF