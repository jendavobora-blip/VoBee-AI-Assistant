events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Enable gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css application/json application/javascript video/mp4 image/jpeg image/png;

    # Cache settings
    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=content_cache:10m max_size=10g inactive=60m;
    proxy_cache_key "$scheme$request_method$host$request_uri";

    server {
        listen 8080;
        server_name localhost;

        # Enable caching
        proxy_cache content_cache;
        proxy_cache_valid 200 60m;
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
        add_header X-Cache-Status $upstream_cache_status;

        # Serve static content
        location /content/ {
            alias /app/content/;
            expires 30d;
            add_header Cache-Control "public, immutable";
        }

        # Images
        location /images/ {
            alias /app/content/images/;
            expires 7d;
            add_header Cache-Control "public";
        }

        # Videos
        location /videos/ {
            alias /app/content/videos/;
            expires 7d;
            add_header Cache-Control "public";
            
            # Enable range requests for video streaming
            add_header Accept-Ranges bytes;
        }

        # Health check
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
    }
}
